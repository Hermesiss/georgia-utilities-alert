<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Utilities Alert - Statistics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Georgia Utilities Alert Statistics</h1>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="setLanguage('ka')">ქართული</button>
                <button class="btn btn-outline-primary" onclick="setLanguage('en')">English</button>
                <button class="btn btn-outline-primary" onclick="setLanguage('ru')">Русский</button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title" id="searchTitle">Search by Street</h5>
                <div class="input-group mb-3">
                    <input type="text" id="streetSearch" class="form-control" placeholder="Enter street name...">
                    <button class="btn btn-primary" onclick="searchStreet()">Search</button>
                </div>
            </div>
        </div>

        <div id="cities" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="citiesTitle">Select City</h5>
                    <div id="citiesContent">
                        <div class="list-group" id="citiesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="statsTitle">Statistics</h5>
                    <div id="statsContent">
                        <p>Select a city to see statistics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStreet = '';
        let currentLanguage = 'en';
        const translations = {
            ka: {
                searchTitle: 'მოიძიეთ ქუჩა',
                citiesTitle: 'აირჩიეთ ქალაქი',
                selectedCity: 'აირჩიეთ ქალაქი',
                statsTitle: 'სტატისტიკა',
                searchPlaceholder: 'ქუჩის სახელი...',
                search: 'ძებნა',
                noCities: 'ამ ქუჩისთვის ქალაქები ვერ მოიძებნა',
                totalDisconnections: 'სულ გათიშვები',
                lastDisconnection: 'ბოლო გათიშვა',
                recentAlerts: 'ბოლო განცხადებები',
                error: 'შეცდომა მონაცემების მიღებისას'
            },
            en: {
                searchTitle: 'Search by Street',
                citiesTitle: 'Select City',
                selectedCity: 'Selected City',
                statsTitle: 'Statistics',
                searchPlaceholder: 'Enter street name...',
                search: 'Search',
                noCities: 'No cities found for this street',
                totalDisconnections: 'Total Disconnections',
                lastDisconnection: 'Last Disconnection',
                recentAlerts: 'Recent Alerts',
                error: 'Error fetching data'
            },
            ru: {
                searchTitle: 'Поиск по улице',
                citiesTitle: 'Выберите город',
                statsTitle: 'Статистика',
                selectedCity: 'Выбранный город',
                searchPlaceholder: 'Введите название улицы...',
                search: 'Поиск',
                noCities: 'Города не найдены для этой улицы',
                totalDisconnections: 'Всего отключений',
                lastDisconnection: 'Последнее отключение',
                recentAlerts: 'Последние объявления',
                error: 'Ошибка при получении данных'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('searchTitle').textContent = translations[lang].searchTitle;
            document.getElementById('citiesTitle').textContent = translations[lang].citiesTitle;
            document.getElementById('statsTitle').textContent = translations[lang].statsTitle;
            document.getElementById('streetSearch').placeholder = translations[lang].searchPlaceholder;
            document.querySelector('.btn-primary').textContent = translations[lang].search;
        }

        function transliterateToGeorgian(text) {
            // Detect input language
            const hasCyrillic = /[\u0400-\u04FF]/.test(text);
            const hasGeorgian = /[\u10A0-\u10FF]/.test(text);

            if (hasGeorgian) return text;

            const mapping = hasCyrillic ? {
                // Two-character combinations first
                'дз': 'ძ',
                'дж': 'ჯ',
                'шч': 'შჩ',
                'ия': 'ია',
                'иу': 'იუ',
                // Single characters
                'а': 'ა',
                'б': 'ბ',
                'в': 'ვ',
                'г': 'გ',
                'д': 'დ',
                'е': 'ე',
                'ё': 'ო',
                'ж': 'ჟ',
                'з': 'ზ',
                'и': 'ი',
                'й': 'ი',
                'к': 'კ',
                'л': 'ლ',
                'м': 'მ',
                'н': 'ნ',
                'о': 'ო',
                'п': 'პ',
                'р': 'რ',
                'с': 'ს',
                'т': 'ტ',
                'у': 'უ',
                'ф': 'ფ',
                'х': 'ხ',
                'ц': 'ც',
                'ч': 'ჩ',
                'ш': 'შ',
                'щ': 'შჩ',
                'ъ': '',
                'ы': 'ი',
                'ь': '',
                'э': 'ე',
                'ю': 'იუ',
                'я': 'ია'
            } : {
                // Two-character combinations first
                'zh': 'ჟ',
                'sh': 'შ',
                'ch': 'ჩ',
                'ts': 'ც',
                'dz': 'ძ',
                'kh': 'ხ',
                'dj': 'ჯ',
                // Single characters
                'a': 'ა',
                'b': 'ბ',
                'g': 'გ',
                'd': 'დ',
                'e': 'ე',
                'v': 'ვ',
                'z': 'ზ',
                't': 'ტ',
                'i': 'ი',
                'k': 'კ',
                'l': 'ლ',
                'm': 'მ',
                'n': 'ნ',
                'o': 'ო',
                'p': 'პ',
                'r': 'რ',
                's': 'ს',
                'j': 'ჯ',
                'h': 'ჰ'
            };

            let result = text.toLowerCase();

            // First handle two-character combinations
            for (const [key, value] of Object.entries(mapping)) {
                if (key.length === 2) {
                    result = result.replace(new RegExp(key, 'g'), value);
                }
            }

            // Then handle single characters
            return result.split('').map(char => mapping[char] || char).join('');
        }

        function transliterateFromGeorgian(text) {
            const mapping = currentLanguage === 'ru' ? {
                'ძ': 'дз',
                'ჯ': 'дж',
                'ა': 'а',
                'ბ': 'б',
                'გ': 'г',
                'დ': 'д',
                'ე': 'е',
                'ვ': 'в',
                'ზ': 'з',
                'ტ': 'т',
                'ი': 'и',
                'კ': 'к',
                'ლ': 'л',
                'მ': 'м',
                'ნ': 'н',
                'ო': 'о',
                'პ': 'п',
                'ჟ': 'ж',
                'რ': 'р',
                'ს': 'с',
                'შ': 'ш',
                'ჩ': 'ч',
                'ც': 'ц',
                'ხ': 'х',
                'ჰ': 'х',
                'თ': 'т',
                'უ': 'у',
                'ქ': 'к',
                'წ': 'ц',
                'ფ': 'ф',
                'ყ': 'к',
            } : {
                'ა': 'a',
                'ბ': 'b',
                'გ': 'g',
                'დ': 'd',
                'ე': 'e',
                'ვ': 'v',
                'ზ': 'z',
                'ტ': 't',
                'ი': 'i',
                'კ': 'k',
                'ლ': 'l',
                'მ': 'm',
                'ნ': 'n',
                'ო': 'o',
                'პ': 'p',
                'ჟ': 'zh',
                'რ': 'r',
                'ს': 's',
                'შ': 'sh',
                'ჩ': 'ch',
                'ც': 'ts',
                'ძ': 'dz',
                'ხ': 'kh',
                'ჯ': 'j',
                'ჰ': 'h',
                'თ': 't',
                'უ': 'u',
                'ქ': 'k',
                'წ': 'ts',
                'ფ': 'f',
                'ყ': 'k'
            };

            return text.split('').map(char => mapping[char] || char).join('');
        }

        async function searchStreet() {
            const street = document.getElementById('streetSearch').value;
            if (!street) return;

            currentStreet = street;
            document.getElementById('cities').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                // Convert input to Georgian for search
                const georgianStreet = transliterateToGeorgian(street);
                console.log("Sending georgian street", georgianStreet)
                const response = await fetch(`/api/stats/street/${encodeURIComponent(georgianStreet)}/cities`);
                const data = await response.json();

                const citiesList = document.getElementById('citiesList');
                citiesList.innerHTML = '';

                if (data.cities.length === 0) {
                    citiesList.innerHTML = `<div class="list-group-item">${translations[currentLanguage].noCities}</div>`;
                    return;
                }

                data.cities.forEach(city => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    // Convert city name to current language
                    const cityName = transliterateFromGeorgian(city.name);
                    item.innerHTML = `
                        ${cityName}
                        <span class="badge bg-primary rounded-pill">${city.count}</span>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        loadCityStats(georgianStreet, city.name);
                    };
                    citiesList.appendChild(item);
                });
            } catch (error) {
                document.getElementById('citiesContent').innerHTML = `<div class="alert alert-danger">${translations[currentLanguage].error}</div>`;
            }
        }

        async function loadCityStats(street, city) {
            document.getElementById('results').style.display = 'block';

            try {
                const response = await fetch(`/api/stats/street/${encodeURIComponent(street)}/city/${encodeURIComponent(city)}`);
                const data = await response.json();

                let html = `
                    <h6>${translations[currentLanguage].searchTitle}: "${transliterateFromGeorgian(street)}" ${translations[currentLanguage].citiesTitle.toLowerCase()}: ${transliterateFromGeorgian(city)}</h6>
                    <ul class="list-group">
                        <li class="list-group-item">${translations[currentLanguage].totalDisconnections}: ${data.total}</li>
                        <li class="list-group-item">${translations[currentLanguage].lastDisconnection}: ${data.lastDisconnection || 'N/A'}</li>
                    </ul>
                `;

                if (data.recentAlerts && data.recentAlerts.length > 0) {
                    html += `<h6 class="mt-3">${translations[currentLanguage].recentAlerts}:</h6><ul class="list-group">`;
                    data.recentAlerts.forEach(alert => {
                        html += `
                            <li class="list-group-item">
                                <strong>${alert.disconnectionDate}</strong><br>
                                ${transliterateFromGeorgian(alert.taskName)}<br>
                                <small>${translations[currentLanguage].selectedCity}: ${transliterateFromGeorgian(alert.regionName)}</small>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }

                document.getElementById('statsContent').innerHTML = html;
            } catch (error) {
                document.getElementById('statsContent').innerHTML = `<div class="alert alert-danger">${translations[currentLanguage].error}</div>`;
            }
        }

        // Set initial language
        setLanguage('en');
    </script>
</body>

</html>