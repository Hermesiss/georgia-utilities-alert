<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Utilities Alert - Statistics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Georgia Utilities Alert Statistics</h1>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="setLanguage('ka')">ქართული</button>
                <button class="btn btn-outline-primary" onclick="setLanguage('en')">English</button>
                <button class="btn btn-outline-primary" onclick="setLanguage('ru')">Русский</button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title" id="searchTitle">Search by Street</h5>
                <div class="input-group mb-3">
                    <input type="text" id="streetSearch" class="form-control" placeholder="Enter street name...">
                    <button class="btn btn-primary" onclick="searchStreet()">Search</button>
                </div>
            </div>
        </div>

        <div id="cities" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="citiesTitle">Select City</h5>
                    <div id="citiesContent">
                        <div class="text-center py-4" id="citiesLoading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div class="list-group" id="citiesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="statsTitle">Statistics</h5>
                    <div id="statsContent">
                        <div class="text-center py-4" id="statsLoading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="statsData">
                            <p>Select a city to see statistics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStreet = '';
        let currentLanguage = 'en';
        const translations = {
            ka: {
                searchTitle: 'მოიძიეთ ქუჩა',
                citiesTitle: 'აირჩიეთ ქალაქი',
                selectedCity: 'აირჩიეთ ქალაქი',
                statsTitle: 'სტატისტიკა',
                searchPlaceholder: 'ქუჩის სახელი...',
                search: 'ძებნა',
                noCities: 'ამ ქუჩისთვის ქალაქები ვერ მოიძებნა',
                totalDisconnections: 'სულ გათიშვები',
                lastDisconnection: 'ბოლო გათიშვა',
                recentAlerts: 'ბოლო განცხადებები',
                error: 'შეცდომა მონაცემების მიღებისას',
                maxDisconnections: 'მაქსიმალური გათიშვები დღეში',
                disconnections: 'გათიშვა',
                maxStreakWith: 'მაქსიმალური უწყვეტი გათიშვების დღეები',
                maxStreakWithout: 'მაქსიმალური უწყვეტი დღეები გათიშვების გარეშე',
                days: 'დღე',
                percentageWith: 'წლის პროცენტი გათიშვებით'
            },
            en: {
                searchTitle: 'Search by Street',
                citiesTitle: 'Select City',
                selectedCity: 'Selected City',
                statsTitle: 'Statistics',
                searchPlaceholder: 'Enter street name...',
                search: 'Search',
                noCities: 'No cities found for this street',
                totalDisconnections: 'Total Disconnections',
                lastDisconnection: 'Last Disconnection',
                recentAlerts: 'Recent Alerts',
                error: 'Error fetching data',
                maxDisconnections: 'Maximum Disconnections in a Day',
                disconnections: 'disconnections',
                maxStreakWith: 'Maximum Consecutive Days with Disconnections',
                maxStreakWithout: 'Maximum Consecutive Days without Disconnections',
                days: 'days',
                percentageWith: 'Percentage of Year with Disconnections'
            },
            ru: {
                searchTitle: 'Поиск по улице',
                citiesTitle: 'Выберите город',
                statsTitle: 'Статистика',
                selectedCity: 'Выбранный город',
                searchPlaceholder: 'Введите название улицы...',
                search: 'Поиск',
                noCities: 'Города не найдены для этой улицы',
                totalDisconnections: 'Всего отключений',
                lastDisconnection: 'Последнее отключение',
                recentAlerts: 'Последние объявления',
                error: 'Ошибка при получении данных',
                maxDisconnections: 'Максимальное количество отключений за день',
                disconnections: 'отключений',
                maxStreakWith: 'Максимальное количество дней подряд с отключениями',
                maxStreakWithout: 'Максимальное количество дней подряд без отключений',
                days: 'дней',
                percentageWith: 'Процент дней в году с отключениями'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('searchTitle').textContent = translations[lang].searchTitle;
            document.getElementById('citiesTitle').textContent = translations[lang].citiesTitle;
            document.getElementById('statsTitle').textContent = translations[lang].statsTitle;
            document.getElementById('streetSearch').placeholder = translations[lang].searchPlaceholder;
            document.querySelector('.btn-primary').textContent = translations[lang].search;
        }

        function transliterateToGeorgian(text) {
            // Detect input language
            const hasCyrillic = /[\u0400-\u04FF]/.test(text);
            const hasGeorgian = /[\u10A0-\u10FF]/.test(text);

            if (hasGeorgian) return text;

            const mapping = hasCyrillic ? {
                // Two-character combinations first
                'дз': 'ძ',
                'дж': 'ჯ',
                'шч': 'შჩ',
                'ия': 'ია',
                'иу': 'იუ',
                // Single characters
                'а': 'ა',
                'б': 'ბ',
                'в': 'ვ',
                'г': 'გ',
                'д': 'დ',
                'е': 'ე',
                'ё': 'ო',
                'ж': 'ჟ',
                'з': 'ზ',
                'и': 'ი',
                'й': 'ი',
                'к': 'კ',
                'л': 'ლ',
                'м': 'მ',
                'н': 'ნ',
                'о': 'ო',
                'п': 'პ',
                'р': 'რ',
                'с': 'ს',
                'т': 'ტ',
                'у': 'უ',
                'ф': 'ფ',
                'х': 'ხ',
                'ц': 'ც',
                'ч': 'ჩ',
                'ш': 'შ',
                'щ': 'შჩ',
                'ъ': '',
                'ы': 'ი',
                'ь': '',
                'э': 'ე',
                'ю': 'იუ',
                'я': 'ია'
            } : {
                // Two-character combinations first
                'zh': 'ჟ',
                'sh': 'შ',
                'ch': 'ჩ',
                'ts': 'ც',
                'dz': 'ძ',
                'kh': 'ხ',
                'dj': 'ჯ',
                // Single characters
                'a': 'ა',
                'b': 'ბ',
                'g': 'გ',
                'd': 'დ',
                'e': 'ე',
                'v': 'ვ',
                'z': 'ზ',
                't': 'ტ',
                'i': 'ი',
                'k': 'კ',
                'l': 'ლ',
                'm': 'მ',
                'n': 'ნ',
                'o': 'ო',
                'p': 'პ',
                'r': 'რ',
                's': 'ს',
                'j': 'ჯ',
                'h': 'ჰ'
            };

            let result = text.toLowerCase();

            // First handle two-character combinations
            for (const [key, value] of Object.entries(mapping)) {
                if (key.length === 2) {
                    result = result.replace(new RegExp(key, 'g'), value);
                }
            }

            // Then handle single characters
            return result.split('').map(char => mapping[char] || char).join('');
        }

        function transliterateFromGeorgian(text) {
            const mapping = currentLanguage === 'ru' ? {
                'ძ': 'дз',
                'ჯ': 'дж',
                'ა': 'а',
                'ბ': 'б',
                'გ': 'г',
                'დ': 'д',
                'ე': 'е',
                'ვ': 'в',
                'ზ': 'з',
                'ტ': 'т',
                'ი': 'и',
                'კ': 'к',
                'ლ': 'л',
                'მ': 'м',
                'ნ': 'н',
                'ო': 'о',
                'პ': 'п',
                'ჟ': 'ж',
                'რ': 'р',
                'ს': 'с',
                'შ': 'ш',
                'ჩ': 'ч',
                'ც': 'ц',
                'ხ': 'х',
                'ჰ': 'х',
                'თ': 'т',
                'უ': 'у',
                'ქ': 'к',
                'წ': 'ц',
                'ფ': 'ф',
                'ყ': 'к',
            } : {
                'ა': 'a',
                'ბ': 'b',
                'გ': 'g',
                'დ': 'd',
                'ე': 'e',
                'ვ': 'v',
                'ზ': 'z',
                'ტ': 't',
                'ი': 'i',
                'კ': 'k',
                'ლ': 'l',
                'მ': 'm',
                'ნ': 'n',
                'ო': 'o',
                'პ': 'p',
                'ჟ': 'zh',
                'რ': 'r',
                'ს': 's',
                'შ': 'sh',
                'ჩ': 'ch',
                'ც': 'ts',
                'ძ': 'dz',
                'ხ': 'kh',
                'ჯ': 'j',
                'ჰ': 'h',
                'თ': 't',
                'უ': 'u',
                'ქ': 'k',
                'წ': 'ts',
                'ფ': 'f',
                'ყ': 'k'
            };

            return text.split('').map(char => mapping[char] || char).join('');
        }

        let chart = null;

        async function loadCityStats(street, city) {
            document.getElementById('results').style.display = 'block';
            document.getElementById('statsLoading').style.display = 'block';
            document.getElementById('statsData').innerHTML = '';

            try {
                const response = await fetch(`/api/stats/street/${encodeURIComponent(street)}/city/${encodeURIComponent(city)}`);
                const data = await response.json();

                document.getElementById('statsLoading').style.display = 'none';

                let html = `
                    <h6>${translations[currentLanguage].searchTitle}: "${transliterateFromGeorgian(street)}" ${translations[currentLanguage].citiesTitle.toLowerCase()}: ${transliterateFromGeorgian(city)}</h6>
                    <ul class="list-group">
                        <li class="list-group-item">${translations[currentLanguage].totalDisconnections}: ${data.total}</li>
                        <li class="list-group-item">${translations[currentLanguage].lastDisconnection}: ${data.lastDisconnection || 'N/A'}</li>
                    </ul>
                    <div class="mt-4">
                        <canvas id="disconnectionChart"></canvas>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${translations[currentLanguage].maxDisconnections}</h5>
                                    <p class="card-text">${data.achievements.maxDisconnectionsInDay} ${translations[currentLanguage].disconnections} (${dayjs(data.achievements.maxDisconnectionsDate).format('MMMM D, YYYY')})</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${translations[currentLanguage].maxStreakWith}</h5>
                                    <p class="card-text">${data.achievements.maxStreakWithDisconnections} ${translations[currentLanguage].days}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${translations[currentLanguage].maxStreakWithout}</h5>
                                    <p class="card-text">${data.achievements.maxStreakWithoutDisconnections} ${translations[currentLanguage].days}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${translations[currentLanguage].percentageWith}</h5>
                                    <p class="card-text">${data.achievements.percentageWithDisconnections.toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('statsData').innerHTML = html;

                // Destroy existing chart if it exists
                if (chart) {
                    chart.destroy();
                }

                // Create new chart
                const ctx = document.getElementById('disconnectionChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dailyData.dates.map(date => dayjs(date).format('MMM D')),
                        datasets: [{
                            label: translations[currentLanguage].totalDisconnections,
                            data: data.dailyData.counts,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return dayjs(data.dailyData.dates[tooltipItems[0].dataIndex]).format('MMMM D, YYYY');
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading city stats", error)
                document.getElementById('statsLoading').style.display = 'none';
                document.getElementById('statsData').innerHTML = `<div class="alert alert-danger">${translations[currentLanguage].error}</div>`;
            }
        }

        async function searchStreet() {
            const street = document.getElementById('streetSearch').value;
            if (!street) return;

            currentStreet = street;
            document.getElementById('cities').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('citiesLoading').style.display = 'block';
            document.getElementById('citiesList').innerHTML = '';

            try {
                // Convert input to Georgian for search
                const georgianStreet = transliterateToGeorgian(street);
                console.log("Sending georgian street", georgianStreet)
                const response = await fetch(`/api/stats/street/${encodeURIComponent(georgianStreet)}/cities`);
                const data = await response.json();

                document.getElementById('citiesLoading').style.display = 'none';

                if (data.cities.length === 0) {
                    document.getElementById('citiesList').innerHTML = `<div class="list-group-item">${translations[currentLanguage].noCities}</div>`;
                    return;
                }

                data.cities.forEach(city => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    // Convert city name to current language
                    const cityName = transliterateFromGeorgian(city.name);
                    item.innerHTML = `
                        ${cityName}
                        <span class="badge bg-primary rounded-pill">${city.count}</span>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        loadCityStats(georgianStreet, city.name);
                    };
                    document.getElementById('citiesList').appendChild(item);
                });
            } catch (error) {
                console.error("Error searching street", error)
                document.getElementById('citiesLoading').style.display = 'none';
                document.getElementById('citiesContent').innerHTML = `<div class="alert alert-danger">${translations[currentLanguage].error}</div>`;
            }
        }

        // Set initial language
        setLanguage('en');
    </script>
</body>

</html>